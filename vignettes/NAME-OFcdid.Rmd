---
title: "Introduction to cDiD with Multiple Time Periods"
author: "Joel Cuerrier"
date:  "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to cDiD with Multiple Time Periods}
  %\VignetteEngine{knitr::rmarkdown}    
  %\VignetteEncoding{UTF-8}
---

****
```{r}
# browseVignettes("did")
```

<!-- rmarkdown::pandoc_version() -->



```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Attribution of Vignettes to Original Author
The vignettes included in this library are based on those authored by [Brantly Callaway and Pedro H.C. Sant'Anna] for the 'did' package. We have adapted the content for use in this library to provide users with accessible and informative documentation. The original vignettes authored by [Brantly Callaway and Pedro H.C. Sant'Anna] can be found in the 'did' package documentation [https://bcallaway11.github.io/did/articles/did-basics.html].

## Introduction 
This vignette provides an introductory overview of utilizing Chained-Difference-in-Differences (cDiD) designs to identify and estimate the average impact of engaging in a treatment, with a specific emphasis on leveraging functionalities from the cdid package. 

The package is based on the "did" package developed by Brently Callaway and Pedro H.C. Sant'Anna  (2020) and extends its capabilities to accommodate multiple time periods, variations in treatment timing, treatment effect heterogeneity, general missing data patterns, and sample selection observable. 

As a result, the output generated by  the 'cdid' library mirrors that of the did package. The outputs produced by my 'cdid' align seamlessly with those of the 'did' package. Examples demonstrating this compatibility are provided in the documentation for reference.

* The cdid package allows for multiple periods, variation in treatment timing, treatment effect heterogeneity, general missing data patterns, and sample selection on observables.
* The chained DiD rests on a parallel trends assumption, conditioned on being sampled. 
* The chained DiD is robust to some forms of attrition caused by unobservable heterogeneity.
* We identify three main advantages of our approach: (1) it does not require having a balanced panel subsample as it is the case with a standard DiD; (2) identifying assumption allows for sample selection on time-persistent unobservable (or latent) factors, unlike the cross-section DiD which treats the sample as repeated cross-sectional data; and (3) it may also deliver efficiency gains compared to existing methods, notably when the outcome variable is highly time-persistent.
* The cdid package is designed to provide group-time average treatment effects. Future updates to the package will expand its capabilities to include event-study type estimates, which encompass treatment effect parameters corresponding to various durations of exposure to the treatment, as well as overall treatment effect estimates.

## Examples with numerical simulations

We propose a simulation design adapted from the first section. Let us specify the
potential outcome as a components of variance:


$$
Y_{it}(D_i) = \alpha_i + \delta_t + \sum_{\tau=2}^{t} \beta_{\tau} D_{i\tau} + \varepsilon_{it}
$$

Where $D_{i\tau} ∈ {0, 1}$ denotes whether individual i has been treated in $\tau$ or earlier. Let us assume that $\tau ∈ {0, ..., T + 1}$ and treatments can only occur in t ≥ 2 so that G ∈ {2, ..., T + 1}. The data generating process is characterized by the following assumptions:

• The individual-specific unobservable heterogeneity is iid gaussian: $\alpha_i ∼ N(1, \alpha^2_{\alpha})$, where $\alpha^2 = 2;$
• The time-specific unobservable heterogeneity is iid gaussian: $\delta_t ∼ N(1, 1)$;
• The treatment effect is constant over time: $\beta_{\tau} = 1$;
• The error term is iid gaussian: $\varepsilon_{it} ∼ N(0, \alpha^2_{\varepsilon})$;
• The probability to receive the treatment at time g, conditional on being treated at g or in the control group, is defined as: 
$$Pr((G_{ig} = 1|X_i, \alpha_i, G_{ig} + C_i = 1)) = \frac{1}{1 + \exp(\theta_0 + \theta_1 X_i + \theta_2 \alpha_i \times g)}$$.
Where $X_i ∼ N(1, 1)$ is observable for every i, unlike $\alpha_i$, and $\theta_0 = −1, \theta_1 = 0.4$ and $\theta_2 = 0$ or $\theta_2 = 0.2$. In the latter case, the treatment probability varies with treatment timing and the unobserved individual heterogeneity;
• The sampling probability in the consecutive periods t, t + 1 conditional on $\alpha_i$ is given by:
$$Pr((S_{it} + 1 = 1|\alpha_i)) = \frac{1}{1 + \exp(\lambda_0 + \lambda_1 \alpha_i \times t)}$$
With $\lambda_0 = −1$, and $\lambda_1 = 0$ or $\lambda_1 = 0.2$, so that the sampling process can also vary with time and the unobserved individual heterogeneity.

We simulate the sampled data in two steps. First, we generate a population sample
for each period t to represent individuals that are either treated at t or in the control
group. Second, we sample from this population using the specified process. We

1. Generate a population of individuals
(a) Draw $N = 2 x max $\frac{n}{E_{\alpha}[Pr(S_{itt+1})]}$ individuals per period in order to have $T + 2$ population samples of $ N $ individuals, where each individual is characterized by a vector $(\alpha_i, \delta_t, X_i, \epsilon_{it})$.
(b) Separately for each population sample g, draw a uniform random number $(\xi_i \in [0, 1])$ per individual. If $\xi_i \leq Pr(G_{it} = 1|X_i, \alpha_i, G_{it} + C_i = 1)$, then set $(G_{ig} = 1, C_i = 0)$, otherwise set $(G_{ig} = 0, C_i = 1)$.
(c) Compute $Y_{it}$ from $(\alpha_{i}, \delta_{t}, X_{i}, ε_{it}, G_{i0}, ..., _{iT+1}, C_{i})$;

2. Sample from this population
(a) Draw a uniform random number $η_{it} ∈ [0, 1]$ per individual i and period t. If $η_{it} ≤ Pr(S_{itt+1} = 1|\alpha_{i}), then set S_{itt+1} = 1$ and $S_{iττ+1} = 0$ for $τ /neq t;
(b) Draw (without replacement) n individuals per period t from the population for which $S_{itt+1} = 1$;
(c) Compute the different estimators.
(d) Repeat steps 1(b)-2(c) 1,000 times and report the mean and standard deviation of the estimators.

## Estimating the average treatment effect 
# Building the dataset

```{r}
set.seed(123)
# browseVignettes("cdid")
# browseVignettes("did")

#importing the package
devtools::install_github("joelcuerrier/cdid", ref = "library",force = TRUE)
library(cdid)
ls("package:cdid")
library(did)
ls("package:did")

# Using the function `fonction_simu_attrition` from the `cdid` package.
# We simulate the data for the following parameter values: $\theta_2 = 0.2, \lambda_1 = 0.2, \sigma_{\alpha} = 2, \sigma_{\epsilon} = 0.5$.
dta=fonction_simu_attrition(nbsimu = 1, theta2_alpha_Gg=0.2, lambda1_alpha_St=0.2, sigma_alpha=2, sigma_epsilon=0.5)

#      id annee  Y1_chaine       X         annee_G   P_Y1_chaine   traite_G  select  
# 6616  1     1  0.7697235   1.3126786       0            0           0         1   
# 6617  2     1  1.4992124   1.6380014       0            0           0         1   
# 6618  3     1  2.4497511   0.1496297       0            0           0         1   
# 6619  4     1 -2.6487611  -0.7435851       0            0           0         1   
# 6620  5     1 -1.1038018   0.4412948       0            0           0         1   
# 6621  6     1 -4.0623397   1.6870456       0            0           0         1   
```


# Estimating the average treatment effect
The function `cdid` estimates the average treatment effect for the chained DiD design. See the documentation here : https://www.davidbenatia.com/publication/chaineddid/.
```{r}

library(BMisc)
example_attgt <- chained(
                  yname="Y1_chaine", 
                  tname="annee",
                  idname="id",
                  gname="annee_G",
                  xformla=~X,
                  data=dta,      
                  anticipation=0,      
                  weightsname=c("P_Y1_chaine"), #St   
                  # weight_assumption="missing_trends",
                  link="logit",
                  bstrap=FALSE,
                  biters=1000,
                  debT=3,
                  finT=8,
                  deb=1,
                  fin=8,
                  select='select',
                  treated='traite_G',
                  pl=FALSE,
                  cores=1,
                  clustervars=NULL)

summary(example_attgt)

```

Our function, 'chained', employs the Difference-in-Differences (DID) methodology to compute group-time average treatment effects. It produces results equivalent to those generated by the 'did' package developed by Callaway. The summary output includes estimates of treatment effects labeled 'att', accompanied by bootstrapped-based standard errors denoted as 'se'. The 'group' and 'time' columns specify corresponding group and time identifiers. Under the assumptions of no-anticipation and parallel trends, treatment effects are identified during periods where 'time' is greater than or equal to 'group' (post-treatment periods for each group). Pseudo group-time average treatment effects are reported for periods where 'time' is less than 'group' (pre-treatment periods for group 'g'). These pseudo effects serve as a pre-test for the parallel trends assumption, provided the no-anticipation assumption holds. Additionally, the summary includes results from a Wald pre-test assessing the validity of the parallel trends assumption.

```{r include_png, echo=FALSE, out.width="80%", fig.cap="Caption for the image"}
knitr::include_graphics("https://github.com/joelcuerrier/cdid/library/R/outputs/plot.png")
# Plotting the results
# did::ggdid(example_attgt)
```

The resulting figure is one that contains separate plots for each group. Notice in the figure above, the first plot is labeled “Group 2”, the second “Group 3”, etc. Then, the figure contains estimates of group-time average treatment effects for each group in each time period along with a simultaneous confidence interval. The red dots in the plots are pre-treatment pseudo group-time average treatment effects and are most useful for pre-testing the parallel trends assumption. The blue dots are post-treatment group-time average treatment effects and should be interpreted as the average effect of participating in the treatment for units in a particular group at a particular point in time (Source: Callaway, Sant'Anna).
## Other features of the did package
The above discussion covered only the most basic case for using the did package. There are a number of simple extensions that are useful in applications.

## Adjustments for Multiple Hypothesis Testing
By default, the did package reports simultaneous confidence bands in plots of group-time average treatment effects with multiple time periods – these are confidence bands that are robust to multiple hypothesis testing [essentially, the idea here is to use the same standard errors but make an adjustment to the critical value to account for multiple testing – in the example in this section, the critical value for a 95% uniform confidence band is 2.73 instead of 1.96]. You can turn this off and compute analytical standard errors and corresponding figures with pointwise confidence intervals by setting bstrap=FALSE, cband=FALSE in the call to att_gt…but we don’t recommend it!(Source: Callaway, Sant'Anna)

## Aggregating group-time average treatment effects
In many applications, there can be a large number of groups and time periods. In this case, it may be infeasible to interpret plots of group-time average treatment effects. The did package provides a number of ways to aggregate group-time average treatment effects using the aggte function.

## Simple Aggregation
One idea that is likely to immediately come to mind is to just return a weighted average of all group-time average treatment effects with weights proportional to the group size. This is available by calling the aggte function with type = simple.

```{r}
agg.simple <- did::aggte(MP = example_attgt, type = "simple")
summary(agg.simple)

```
